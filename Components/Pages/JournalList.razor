@page "/journal-list"
@using Journal_App.Data.Models
@using Journal_App.Data.Abstractions
@inject IJournalEntryService JournalService
@inject NavigationManager Navigation

<div class="journal-list-container">
    <div class="page-header">
        <h1>Journal Entries</h1>
    </div>

    <div class="controls-bar">
        <div class="filter-section">
            <select class="form-select sort-select" @bind="sortOrder">
                <option value="newest">Date (Newest First)</option>
                <option value="oldest">Date (Oldest First)</option>
            </select>
        </div>
        
        <div class="search-section">
            <input type="text" 
                   class="form-control search-input" 
                   placeholder="Search entries..." 
                   @bind="searchTerm" 
                   @bind:event="oninput"
                   @onkeyup="HandleSearch" />
        </div>
        
        <button class="btn btn-primary new-entry-btn" @onclick="NavigateToNewEntry">
            New Entry
        </button>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <p>Loading entries...</p>
        </div>
    }
    else if (filteredEntries == null || !filteredEntries.Any())
    {
        <div class="empty-state">
            <p>No journal entries found. Start writing your first entry!</p>
            <button class="btn btn-primary" @onclick="NavigateToNewEntry">Create Entry</button>
        </div>
    }
    else
    {
        <div class="entries-list">
            @foreach (var entry in GetPaginatedEntries())
            {
                <div class="entry-card">
                    <div class="entry-header">
                        <h3 class="entry-title">@entry.Title</h3>
                        <span class="entry-date">@entry.EntryDate.ToString("MMMM dd, yyyy")</span>
                        <span class="mood-badge @GetMoodClass(entry.PrimaryMood)">Mood: @GetMoodDisplayName(entry.PrimaryMood)</span>
                    </div>
                    
                    <div class="entry-content-preview">
                        <div class="quill-preview ql-editor" @onclick:stopPropagation>
                            @((MarkupString)GetPreviewHtml(entry.Description))
                        </div>
                    </div>
                    
                    <div class="entry-tags">
                        @if (entry.JournalEntryTags != null)
                        {
                            @foreach (var tag in entry.JournalEntryTags.Take(5))
                            {
                                <span class="tag">@tag.Tag?.Name</span>
                            }
                        }
                    </div>
                    
                    <div class="entry-actions">
                        <button class="btn btn-info btn-sm" @onclick="() => ViewEdit(entry.Id)">View/Edit</button>
                        <button class="btn btn-danger btn-sm" @onclick="() => DeleteEntry(entry.Id)">Delete</button>
                    </div>
                </div>
            }
        </div>

        @if (TotalPages > 1)
        {
            <div class="pagination-container">
                <button class="btn btn-primary btn-sm" 
                        disabled="@(currentPage == 1)" 
                        @onclick="PreviousPage">Previous</button>
                <span class="page-info">Page @currentPage of @TotalPages</span>
                <button class="btn btn-primary btn-sm" 
                        disabled="@(currentPage == TotalPages)" 
                        @onclick="NextPage">Next</button>
            </div>
        }
    }
</div>

@code {
    private List<Journalentry>? allEntries;
    private List<Journalentry>? filteredEntries;
    private string searchTerm = string.Empty;
    private string sortOrder = "newest";
    private bool isLoading = true;
    private int currentPage = 1;
    private int pageSize = 5;

    private int TotalPages => filteredEntries == null ? 1 : (int)Math.Ceiling((double)filteredEntries.Count / pageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadEntries();
    }

    private async Task LoadEntries()
    {
        isLoading = true;
        try
        {
            allEntries = await JournalService.GetAllAsync();
            ApplyFilters();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading entries: {ex.Message}");
            allEntries = new List<Journalentry>();
            filteredEntries = new List<Journalentry>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void HandleSearch()
    {
        currentPage = 1;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        if (allEntries == null)
        {
            filteredEntries = new List<Journalentry>();
            return;
        }

        var result = allEntries.AsEnumerable();

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            result = result.Where(e => 
                e.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                e.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        // Apply sort
        result = sortOrder == "newest" 
            ? result.OrderByDescending(e => e.EntryDate)
            : result.OrderBy(e => e.EntryDate);

        filteredEntries = result.ToList();
    }

    private List<Journalentry> GetPaginatedEntries()
    {
        if (filteredEntries == null) return new List<Journalentry>();
        
        return filteredEntries
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private void PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
        }
    }

    private void NextPage()
    {
        if (currentPage < TotalPages)
        {
            currentPage++;
        }
    }

    private void NavigateToNewEntry()
    {
        Navigation.NavigateTo("/write-journal");
    }

    private void ViewEdit(Guid id)
    {
        Navigation.NavigateTo($"/write-journal/{id}");
    }

    private async Task DeleteEntry(Guid id)
    {
        var result = await JournalService.DeleteAsync(id);
        if (result)
        {
            await LoadEntries();
        }
    }

    private string GetPreviewHtml(string htmlContent)
    {
        if (string.IsNullOrEmpty(htmlContent))
            return "<p><em>No content</em></p>";

        // Strip HTML tags for preview if content is too long
        var plainText = System.Text.RegularExpressions.Regex.Replace(htmlContent, "<.*?>", string.Empty);
        
        if (plainText.Length <= 200)
            return htmlContent;

        // If too long, truncate plain text and wrap in paragraph
        var truncated = plainText.Substring(0, 200) + "...";
        return $"<p>{System.Net.WebUtility.HtmlEncode(truncated)}</p>";
    }

    private string TruncateDescription(string description, int maxLength)
    {
        if (string.IsNullOrEmpty(description)) return string.Empty;
        
        // Strip HTML tags for truncation
        var plainText = System.Text.RegularExpressions.Regex.Replace(description, "<.*?>", string.Empty);
        
        return plainText.Length <= maxLength 
            ? plainText 
            : plainText.Substring(0, maxLength) + "...";
    }

    private string GetMoodDisplayName(MoodCategory mood)
    {
        return mood switch
        {
            MoodCategory.Happy or MoodCategory.Excited or MoodCategory.Relaxed 
                or MoodCategory.Grateful or MoodCategory.Confident => "Positive",
            MoodCategory.Sad or MoodCategory.Angry or MoodCategory.Stressed 
                or MoodCategory.Lonely or MoodCategory.Anxious => "Negative",
            _ => "Neutral"
        };
    }

    private string GetMoodClass(MoodCategory mood)
    {
        return mood switch
        {
            MoodCategory.Happy or MoodCategory.Excited or MoodCategory.Relaxed 
                or MoodCategory.Grateful or MoodCategory.Confident => "mood-positive",
            MoodCategory.Sad or MoodCategory.Angry or MoodCategory.Stressed 
                or MoodCategory.Lonely or MoodCategory.Anxious => "mood-negative",
            _ => "mood-neutral"
        };
    }
}
