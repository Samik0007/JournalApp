@page "/write-journal"
@page "/write-journal/{EntryId:guid}"
@using Journal_App.Data.Models
@using Journal_App.Data.Abstractions
@inject IJournalEntryService JournalService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Elevation="2" Class="pa-4">
        <MudText Typo="Typo.h5" Class="mb-4">@(isEditMode ? "Edit Entry" : "New Journal Entry")</MudText>

        <!-- Title -->
        <MudTextField @bind-Value="title" 
                      Label="Entry Title" 
                      Variant="Variant.Outlined" 
                      FullWidth 
                      Class="mb-4" />

        <!-- Quill Editor -->
        <MudPaper Elevation="0" Class="mb-4" Style="border:1px solid #ccc; border-radius:4px;">
            <div id="journal-quill" style="min-height:250px;"></div>
        </MudPaper>

        <!-- Mood Selection -->
        <MudText Typo="Typo.h6" Class="mb-2">Mood Selection</MudText>
        
        <MudText Typo="Typo.subtitle2" Class="mb-2">Primary Mood (required)</MudText>
        <MudRadioGroup @bind-Value="primaryMoodGroup" Class="mb-3">
            <MudRadio Value="@("Positive")" Color="Color.Success">Positive</MudRadio>
            <MudRadio Value="@("Neutral")" Color="Color.Default">Neutral</MudRadio>
            <MudRadio Value="@("Negative")" Color="Color.Error">Negative</MudRadio>
        </MudRadioGroup>

        <MudText Typo="Typo.subtitle2" Class="mb-2">Secondary Moods (up to two)</MudText>
        <div class="mood-checkboxes mb-4">
            @foreach (var mood in GetSecondaryMoodOptions())
            {
                var localMood = mood;
                <label class="mood-checkbox-label">
                    <input type="checkbox" 
                           checked="@IsSecondaryMoodSelected(localMood)"
                           @onchange="@(e => SetSecondaryMoodBinding(localMood, (bool)e.Value!))"
                           disabled="@(!IsSecondaryMoodSelected(localMood) && secondaryMoods.Count >= 2)" />
                    <span>@localMood.ToString()</span>
                </label>
            }
        </div>

        <!-- Tags -->
        <MudText Typo="Typo.h6" Class="mb-2">Tags (Optional)</MudText>
        
        <!-- Custom Tag Input -->
        <MudText Typo="Typo.subtitle2" Class="mb-2">Custom Tags</MudText>
        <div class="d-flex gap-2 mb-2">
            <MudTextField @bind-Value="customTagInput"
                         Label="Add custom tag"
                         Variant="Variant.Outlined"
                         OnKeyDown="HandleCustomTagKeyDown"
                         Class="flex-grow-1" />
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       OnClick="AddCustomTag"
                       Disabled="string.IsNullOrWhiteSpace(customTagInput)">
                Add Custom Tag
            </MudButton>
        </div>
        <MudText Typo="Typo.caption" Class="mb-3">Press Enter or click "Add Custom Tag" to create your own tag</MudText>
        
        <!-- Pre-built Tags -->
        <MudText Typo="Typo.subtitle2" Class="mb-2">Pre-built Tags</MudText>
        <MudText Typo="Typo.caption" Class="mb-2">
            Work, Career, Studies, Family, Friends, Relationships, Health, Fitness, Personal Growth, Self-care, 
            Hobbies, Travel, Nature, Finance, Spirituality, Birthday, Holiday, Vacation, Celebration, Exercise, 
            Reading, Writing, Cooking, Meditation, Yoga, Music, Shopping, Parenting, Projects, Planning, Reflection
        </MudText>
        <div class="prebuilt-tags-grid mb-3">
            @foreach (var tag in availableTags.Where(t => t.IsPrebuilt).OrderBy(t => t.Name))
            {
                var localTag = tag;
                var isSelected = selectedTags.Contains(localTag.Name);
                <button type="button" 
                        class="prebuilt-tag-button @(isSelected ? "selected" : "")"
                        @onclick="() => TogglePrebuiltTag(localTag.Name)">
                    @localTag.Name
                </button>
            }
        </div>
        
        <!-- Selected Tags Display -->
        <MudText Typo="Typo.subtitle2" Class="mb-2">Selected Tags</MudText>
        <div class="tag-chips mb-4">
            @if (selectedTags.Any())
            {
                @foreach (var tag in selectedTags)
                {
                    var localTag = tag;
                    var isCustom = !availableTags.Any(t => t.IsPrebuilt && t.Name.Equals(localTag, StringComparison.OrdinalIgnoreCase));
                    <span class="tag-chip @(isCustom ? "custom-tag" : "prebuilt-tag")">
                        <span class="tag-type-indicator">@(isCustom ? "Custom" : "Pre-built")</span>
                        @localTag
                        <button type="button" class="tag-remove" @onclick="@(() => RemoveTag(localTag))">×</button>
                    </span>
                }
            }
            else
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary">No tags selected</MudText>
            }
        </div>

        <!-- Category -->
        <MudGrid Class="mb-4">
            <MudItem xs="12">
                <MudSelect @bind-Value="category" Label="Category" Variant="Variant.Outlined" FullWidth>
                    <MudSelectItem Value="@("Personal")">Personal</MudSelectItem>
                    <MudSelectItem Value="@("Work")">Work</MudSelectItem>
                    <MudSelectItem Value="@("Health")">Health</MudSelectItem>
                    <MudSelectItem Value="@("Travel")">Travel</MudSelectItem>
                    <MudSelectItem Value="@("Learning")">Learning</MudSelectItem>
                    <MudSelectItem Value="@("Relationships")">Relationships</MudSelectItem>
                    <MudSelectItem Value="@("Goals")">Goals</MudSelectItem>
                    <MudSelectItem Value="@("Other")">Other</MudSelectItem>
                </MudSelect>
            </MudItem>
        </MudGrid>

        <!-- Action Buttons -->
        <MudStack Row Justify="Justify.FlexEnd" Spacing="2">
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Default" 
                       OnClick="Cancel">
                Cancel
            </MudButton>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       OnClick="SaveEntry"
                       Disabled="isSaving">
                @(isSaving ? "Saving..." : (isEditMode ? "Update Entry" : "Save Entry"))
            </MudButton>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public Guid? EntryId { get; set; }

    private string title = string.Empty;
    private string description = string.Empty;
    private string primaryMoodGroup = "Neutral";
    private MoodCategory primaryMood = MoodCategory.Calm;
    private List<MoodCategory> secondaryMoods = new();
    private List<string> selectedTags = new();
    private string category = "Personal";
    
    private string tagSearchTerm = string.Empty;
    private string customTagInput = string.Empty;
    private List<Tag> availableTags = new();
    
    private bool isEditMode = false;
    private bool isSaving = false;

    private bool _quillInitialized;

    protected override async Task OnInitializedAsync()
    {
        await LoadAvailableTags();
        
        if (EntryId.HasValue && EntryId.Value != Guid.Empty)
        {
            isEditMode = true;
            await LoadEntry(EntryId.Value);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("journalQuill.init", "journal-quill", description);
            _quillInitialized = true;
        }
        else if (_quillInitialized && isEditMode && !string.IsNullOrEmpty(description))
        {
            // Update editor content when loading entry in edit mode
            await JS.InvokeVoidAsync("journalQuill.setHtml", "journal-quill", description);
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload entry when EntryId parameter changes
        if (EntryId.HasValue && EntryId.Value != Guid.Empty && !isEditMode)
        {
            isEditMode = true;
            await LoadEntry(EntryId.Value);
            
            if (_quillInitialized && !string.IsNullOrEmpty(description))
            {
                await JS.InvokeVoidAsync("journalQuill.setHtml", "journal-quill", description);
            }
        }
    }

    private async Task LoadAvailableTags()
    {
        try
        {
            var prebuiltTags = await JournalService.GetPrebuiltTagsAsync();
            var customTags = await JournalService.GetCustomTagsAsync();
            availableTags = prebuiltTags.Concat(customTags).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tags: {ex.Message}");
            availableTags = new List<Tag>();
        }
    }

    private async Task LoadEntry(Guid id)
    {
        try
        {
            var entry = await JournalService.GetByIdAsync(id);
            if (entry != null)
            {
                title = entry.Title;
                description = entry.Description;
                primaryMood = entry.PrimaryMood;
                primaryMoodGroup = GetMoodGroup(entry.PrimaryMood);
                category = entry.Category;
                
                secondaryMoods.Clear();
                if (entry.SecondaryMood1.HasValue)
                    secondaryMoods.Add(entry.SecondaryMood1.Value);
                if (entry.SecondaryMood2.HasValue)
                    secondaryMoods.Add(entry.SecondaryMood2.Value);

                selectedTags = entry.JournalEntryTags?
                    .Select(t => t.Tag?.Name ?? string.Empty)
                    .Where(n => !string.IsNullOrEmpty(n))
                    .ToList() ?? new List<string>();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading entry: {ex.Message}", Severity.Error);
        }
    }

    private string GetMoodGroup(MoodCategory mood)
    {
        return mood switch
        {
            MoodCategory.Happy or MoodCategory.Excited or MoodCategory.Relaxed 
                or MoodCategory.Grateful or MoodCategory.Confident => "Positive",
            MoodCategory.Sad or MoodCategory.Angry or MoodCategory.Stressed 
                or MoodCategory.Lonely or MoodCategory.Anxious => "Negative",
            _ => "Neutral"
        };
    }

    private List<MoodCategory> GetSecondaryMoodOptions()
    {
        return primaryMoodGroup switch
        {
            "Positive" => new List<MoodCategory> 
            { 
                MoodCategory.Happy, MoodCategory.Excited, MoodCategory.Relaxed,
                MoodCategory.Grateful, MoodCategory.Confident 
            },
            "Negative" => new List<MoodCategory> 
            { 
                MoodCategory.Sad, MoodCategory.Angry, MoodCategory.Stressed,
                MoodCategory.Lonely, MoodCategory.Anxious 
            },
            _ => new List<MoodCategory> 
            { 
                MoodCategory.Calm, MoodCategory.Thoughtful, MoodCategory.Curious,
                MoodCategory.Nostalgic, MoodCategory.Bored 
            }
        };
    }

    private bool IsSecondaryMoodSelected(MoodCategory mood) => secondaryMoods.Contains(mood);

    private void SetSecondaryMoodBinding(MoodCategory mood, bool value)
    {
        if (value)
        {
            if (secondaryMoods.Count < 2 && !secondaryMoods.Contains(mood))
                secondaryMoods.Add(mood);
        }
        else
        {
            secondaryMoods.Remove(mood);
        }
    }

    private async Task<IEnumerable<string>> SearchTags(string value, CancellationToken ct)
    {
        if (string.IsNullOrWhiteSpace(value))
            return availableTags.Select(t => t.Name);

        return availableTags
            .Where(t => t.Name.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Select(t => t.Name);
    }

    private void AddCustomTag()
    {
        if (!string.IsNullOrWhiteSpace(customTagInput))
        {
            var trimmedTag = customTagInput.Trim();
            if (!selectedTags.Contains(trimmedTag, StringComparer.OrdinalIgnoreCase))
            {
                selectedTags.Add(trimmedTag);
                
                // Add to available tags if it's a new custom tag
                if (!availableTags.Any(t => t.Name.Equals(trimmedTag, StringComparison.OrdinalIgnoreCase)))
                {
                    availableTags.Add(new Tag
                    {
                        Id = Guid.NewGuid(),
                        Name = trimmedTag,
                        IsPrebuilt = false,
                        CreatedAt = DateTime.UtcNow
                    });
                }
            }
            customTagInput = string.Empty;
        }
    }

    private void TogglePrebuiltTag(string tagName)
    {
        if (selectedTags.Contains(tagName, StringComparer.OrdinalIgnoreCase))
        {
            selectedTags.Remove(tagName);
        }
        else
        {
            selectedTags.Add(tagName);
        }
    }

    private void HandleCustomTagKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(customTagInput))
        {
            AddCustomTag();
        }
    }

    private void RemoveTag(string tag)
    {
        selectedTags.Remove(tag);
    }

    private void OnTagSelected(string value)
    {
        tagSearchTerm = value;

        if (!string.IsNullOrWhiteSpace(value))
        {
            var trimmedTag = value.Trim();
            if (!selectedTags.Contains(trimmedTag, StringComparer.OrdinalIgnoreCase))
            {
                selectedTags.Add(trimmedTag);
                
                // Add to available tags if it's a new custom tag
                if (!availableTags.Any(t => t.Name.Equals(trimmedTag, StringComparison.OrdinalIgnoreCase)))
                {
                    availableTags.Add(new Tag
                    {
                        Id = Guid.NewGuid(),
                        Name = trimmedTag,
                        IsPrebuilt = false,
                        CreatedAt = DateTime.UtcNow
                    });
                }
            }
            tagSearchTerm = string.Empty;
        }
    }

    private void HandleTagKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(tagSearchTerm))
        {
            AddCustomTag();
        }
    }

    private async Task SaveEntry()
    {
        description = await JS.InvokeAsync<string>("journalQuill.getHtml", "journal-quill");

        if (string.IsNullOrWhiteSpace(title))
        {
            Snackbar.Add("Title is required.", Severity.Warning);
            return;
        }

        if (string.IsNullOrWhiteSpace(description) || description == "<p><br></p>")
        {
            Snackbar.Add("Content is required.", Severity.Warning);
            return;
        }

        // Map primary mood based on group
        primaryMood = primaryMoodGroup switch
        {
            "Positive" => MoodCategory.Happy,
            "Negative" => MoodCategory.Sad,
            _ => MoodCategory.Calm
        };

        isSaving = true;

        try
        {
            MoodCategory? secondary1 = secondaryMoods.Count > 0 ? secondaryMoods[0] : null;
            MoodCategory? secondary2 = secondaryMoods.Count > 1 ? secondaryMoods[1] : null;

            if (isEditMode && EntryId.HasValue)
            {
                await JournalService.UpdateAsync(
                    EntryId.Value, title, description, primaryMood, category,
                    secondary1, secondary2, selectedTags);
                Snackbar.Add("Entry updated successfully!", Severity.Success);
            }
            else
            {
                await JournalService.CreateAsync(
                    title, description, primaryMood, category,
                    secondary1, secondary2, selectedTags, null);
                Snackbar.Add("Entry saved successfully!", Severity.Success);
                
                // Clear form
                title = string.Empty;
                description = string.Empty;
                primaryMoodGroup = "Neutral";
                secondaryMoods.Clear();
                selectedTags.Clear();
                category = "Personal";
                await JS.InvokeVoidAsync("journalQuill.setHtml", "journal-quill", "");
            }

            await Task.Delay(500);
            Navigation.NavigateTo("/journal-list");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving entry: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/journal-list");
    }
}