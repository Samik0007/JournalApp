@page "/home"
@using Journal_App.Data.Abstractions
@using Journal_App.Data.Models
@inject IJournalEntryService JournalService
@inject NavigationManager Navigation

<div class="dashboard-container">
    <div class="welcome-section">
        <h1>Welcome back!</h1>
        <p class="date-display">@DateTime.Today.ToString("dddd, MMMM dd, yyyy")</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">📝</div>
            <div class="stat-info">
                <span class="stat-value">@totalEntries</span>
                <span class="stat-label">Total Entries</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">🔥</div>
            <div class="stat-info">
                <span class="stat-value">@currentStreak</span>
                <span class="stat-label">Day Streak</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">📅</div>
            <div class="stat-info">
                <span class="stat-value">@entriesThisMonth</span>
                <span class="stat-label">This Month</span>
            </div>
        </div>
    </div>

    <div class="action-section">
        @if (hasTodayEntry)
        {
            <div class="today-status completed">
                <span class="status-icon">✅</span>
                <span>You've written today's entry!</span>
            </div>
        }
        else
        {
            <div class="today-status pending">
                <span class="status-icon">📖</span>
                <span>You haven't written today yet</span>
            </div>
        }
        
        <button class="btn btn-primary btn-lg" @onclick="NavigateToWrite">
            @(hasTodayEntry ? "Edit Today's Entry" : "Write Today's Entry")
        </button>
    </div>

    <div class="recent-section">
        <div class="section-header">
            <h2>Recent Entries</h2>
            <a href="journal-list" class="view-all-link">View All →</a>
        </div>
        
        @if (recentEntries != null && recentEntries.Any())
        {
            <div class="recent-entries">
                @foreach (var entry in recentEntries.Take(3))
                {
                    <div class="recent-card" @onclick="() => ViewEntry(entry.Id)">
                        <div class="recent-header">
                            <span class="recent-title">@entry.Title</span>
                            <span class="recent-date">@entry.EntryDate.ToString("MMM dd")</span>
                        </div>
                        <p class="recent-preview">@TruncateText(entry.Description, 100)</p>
                        <span class="mood-indicator @GetMoodClass(entry.PrimaryMood)">
                            @GetMoodEmoji(entry.PrimaryMood) @entry.PrimaryMood
                        </span>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-recent">
                <p>No entries yet. Start journaling today!</p>
            </div>
        }
    </div>
</div>

@code {
    private int totalEntries = 0;
    private int currentStreak = 0;
    private int entriesThisMonth = 0;
    private bool hasTodayEntry = false;
    private Journalentry? todayEntry;
    private List<Journalentry>? recentEntries;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            var allEntries = await JournalService.GetAllAsync();
            totalEntries = allEntries?.Count ?? 0;

            currentStreak = await JournalService.GetDailyStreakAsync();

            var startOfMonth = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
            var monthEntries = await JournalService.GetEntriesByDateRangeAsync(startOfMonth, DateTime.Today);
            entriesThisMonth = monthEntries?.Count ?? 0;

            todayEntry = await JournalService.GetTodayEntryAsync();
            hasTodayEntry = todayEntry != null;

            recentEntries = allEntries?.Take(3).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
    }

    private void NavigateToWrite()
    {
        if (hasTodayEntry && todayEntry != null)
        {
            Navigation.NavigateTo($"/write-journal/{todayEntry.Id}");
        }
        else
        {
            Navigation.NavigateTo("/write-journal");
        }
    }

    private void ViewEntry(Guid id)
    {
        Navigation.NavigateTo($"/write-journal/{id}");
    }

    private string TruncateText(string text, int maxLength)
    {
        if (string.IsNullOrEmpty(text)) return string.Empty;
        return text.Length <= maxLength ? text : text.Substring(0, maxLength) + "...";
    }

    private string GetMoodClass(MoodCategory mood)
    {
        return mood switch
        {
            MoodCategory.Happy or MoodCategory.Excited or MoodCategory.Relaxed 
                or MoodCategory.Grateful or MoodCategory.Confident => "mood-positive",
            MoodCategory.Sad or MoodCategory.Angry or MoodCategory.Stressed 
                or MoodCategory.Lonely or MoodCategory.Anxious => "mood-negative",
            _ => "mood-neutral"
        };
    }

    private string GetMoodEmoji(MoodCategory mood)
    {
        return mood switch
        {
            MoodCategory.Happy => "😊",
            MoodCategory.Excited => "🎉",
            MoodCategory.Relaxed => "😌",
            MoodCategory.Grateful => "🙏",
            MoodCategory.Confident => "💪",
            MoodCategory.Sad => "😢",
            MoodCategory.Angry => "😠",
            MoodCategory.Stressed => "😰",
            MoodCategory.Lonely => "😔",
            MoodCategory.Anxious => "😟",
            MoodCategory.Neutral => "😐",
            MoodCategory.Calm => "😇",
            MoodCategory.Thoughtful => "🤔",
            MoodCategory.Curious => "🧐",
            MoodCategory.Nostalgic => "🥹",
            MoodCategory.Bored => "😑",
            _ => "📝"
        };
    }
}
